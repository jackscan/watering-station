<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Watering Station</title>
    <!-- <script src="jquery-3.2.1.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.bundle.min.js"></script>
  </head>
  <body>
      <canvas id="wchart" width="400" height="200"></canvas>
      <script>
        var chart = new Chart(document.getElementById("wchart"), {
          type: 'bar',
          data: {
            labels: [],
            datasets: [
              {
                type: 'line',
                data: [],
                yAxisID: 'moist-y-axis',
                label: "Moisture",
                borderColor: "#30a000",
                backgroundColor: "#60c010",
                fill: false
              },
              {
                type: 'bar',
                data: [],
                yAxisID: 'water-y-axis',
                label: "Watering",
                borderColor: "#0030a0",
                backgroundColor: "#1060c0",
                fill: false
              }
            ]
          },
          options: {
            scales: {
              yAxes: [{
                id: 'moist-y-axis',
                type: 'linear',
                position: 'left',
                ticks: {
                  suggestedMin: 1200,
                  suggestedMax: 1600,
                }
              }, {
                id: 'water-y-axis',
                type: 'linear',
                position: 'right',
                ticks: {
                  min: 2,
                  max: 12
                }
              }]
            }
          }
        });

        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            var resp = JSON.parse(xhttp.responseText);
            var mlen = resp.moisture.data.length;
            var wlen = resp.water.data.length;
            // var today = new Date();
            // var mstart =
            var mstart = (resp.moisture.time + 1 - (mlen % 24) + 24) % 24;
            var wstart = wlen * 24 - mlen;
            for (var i = 0; i < mlen; ++i) {
              chart.data.labels.push((mstart + i) % 24);
              chart.data.datasets[0].data.push(resp.moisture.data[i]);
              if (i + wstart >= 0 && (i % 24) == resp.water.time) {
                // console.log("pushing " + Math.floor((i + wstart) / 24) + ":" + resp.water.data[Math.floor((i + wstart) / 24)]);
                chart.data.datasets[1].data.push(resp.water.data[Math.floor((i + wstart) / 24)] / 1000);
              } else {
                chart.data.datasets[1].data.push(0);
              }
            }
            chart.update();
          }
        };
        xhttp.open("GET", "/data", true);
        xhttp.send();


      </script>
  </body>
</html>
